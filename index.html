<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GKR QR Card Generator (A4, credit-card size)</title>
  <meta name="description" content="100% client-side QR card generator for GKR Karate membership numbers. No data uploaded or stored." />
  <style>
    :root{
      --brand:#d0021b; --text:#111; --muted:#6b7280; --bg:#f6f7f9;
      --card:#fff; --border:#e5e7eb; --error:#b91c1c; --errorbg:#fee2e2; --errorbd:#fecaca;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Helvetica Neue";background:var(--bg);color:var(--text);line-height:1.45}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:24px;margin:0 0 8px} h2{font-size:18px;margin:24px 0 8px}
    p.small{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .input{display:block;width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-size:14px}
    textarea.input{height:110px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#111;color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#f3f4f6;color:#111;border:1px solid var(--border)}
    .muted{color:var(--muted);font-size:12px}
    .notice{display:flex;gap:10px;background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:10px;font-size:14px}
    .error{display:flex;gap:10px;background:var(--errorbg);border:1px solid var(--errorbd);border-radius:12px;padding:10px;font-size:14px;color:var(--error)}
    .chip{display:inline-block;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr; gap:16px}
    .preview{background:#fff;border:1px solid var(--border);border-radius:16px;padding:12px}
    .card-canvas{position:relative;width:100%;aspect-ratio:85.6/54;border-radius:14px;border:1px solid var(--border);overflow:hidden;background:#fff}
    .brandbar{position:absolute;left:0;right:0;top:0;height:40px;background:var(--brand);display:flex;align-items:center;padding:0 10px;color:#fff;font-weight:600}
    .qrbox{position:absolute;top:56px;left:50%;transform:translateX(-50%);width:160px;height:160px;border-radius:12px;border:1px solid var(--border);display:grid;place-items:center;background:#fff}
    .qrplaceholder{width:128px;height:128px;background:#111}
    .bottom{position:absolute;left:0;right:0;bottom:12px;text-align:center}
    .bottom .num{font-weight:700} .bottom .name{font-size:13px;color:#4b5563}
    .footer{margin-top:12px;font-size:12px;color:var(--muted)} .spacer{height:6px}
    @media (max-width:900px){.row{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
    a{color:#0d5eea;text-decoration:none} a:hover{text-decoration:underline}
  </style>
  <!-- Lightweight libs from CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>GKR QR Card Generator</h1>
    <p class="small">100% client‚Äëside. Nothing is uploaded or stored. Close the tab to clear data. CSV columns: <code>MembershipNumber</code> (required) and <code>Name</code> (optional). Output: A4 PDF with credit‚Äëcard‚Äësize (85.6√ó54&nbsp;mm) cards, rounded corners & crop marks.</p>

    <div class="card">
      <div class="row">
        <div>
          <label class="muted">Upload CSV</label>
          <input id="csvFile" class="input" type="file" accept=".csv" />
          <div class="spacer"></div>

          <label class="muted">Or paste rows (Number,Name)</label>
          <textarea id="pasteArea" class="input" placeholder="00131334,Alex Smith&#10;00098765,Jordan A.&#10;00011122"></textarea>
          <div class="spacer"></div>
          <button id="parseBtn" class="btn btn-secondary">Parse now</button>
          <span class="muted" style="margin-left:8px">Auto‚Äëparses as you type too.</span>
          <div class="spacer"></div>

          <label class="muted">Logo (optional)</label>
          <input id="logoFile" class="input" type="file" accept="image/*" />
        </div>

        <div>
          <div class="notice"><div>üîí</div><div><strong>Privacy:</strong> All processing happens in your browser. Files never leave your device. No data is stored.</div></div>
          <div class="spacer"></div>
          <button id="exportBtn" class="btn" disabled>‚¨áÔ∏è Export A4 PDF</button>
          <span id="count" class="muted" style="margin-left:8px">No records loaded</span>
          <div id="dups" style="margin-top:8px"></div>
          <div id="err" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <h2>Preview (first 8)</h2>
    <div id="previewGrid" class="grid"></div>

    <div class="footer">
      Tip: Credit‚Äëcard size 85.6√ó54&nbsp;mm, QR ‚âà 34&nbsp;mm. Subtle crop marks are included.
    </div>
  </div>

<script>
  async function exportPdf() {
    if (!state.rows.length) { showError("No records to export."); return; }
    clearError();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });
    doc.setFont("helvetica", "normal");

    const CARD_W = 85.6, CARD_H = 54;
    const MARGIN = 10, GUTTER_X = 8, GUTTER_Y = 8;
    const COLS = 2, ROWS = 4;
    const QR_SIZE = 34;

    let col = 0, row = 0;
    for (let i = 0; i < state.rows.length; i++) {
      if (i > 0) {
        col++;
        if (col >= COLS) { col = 0; row++; if (row >= ROWS) { doc.addPage(); row = 0; } }
      }
      const x = MARGIN + col * (CARD_W + GUTTER_X);
      const y = MARGIN + row * (CARD_H + GUTTER_Y);

      // borders & crop marks
      roundedRect(doc, x, y, CARD_W, CARD_H, 3);
      drawCropMarks(doc, x, y, CARD_W, CARD_H);

      // brand bar
      const brandBarH = 10;
      doc.setFillColor("#d0021b");
      doc.roundedRect(x, y, CARD_W, brandBarH, 2, 2, "F");
      doc.setTextColor(255); doc.setFontSize(9);
      doc.text("GKR Karate", x + 3, y + 6.5);

      // QR
      const cardCx = x + CARD_W / 2;
      const qrX = cardCx - QR_SIZE / 2;
      const qrY = y + 14;
      const dataUrl = await QRCode.toDataURL(state.rows[i].number, {
        errorCorrectionLevel: "M", margin: 1, scale: 8,
        color: { dark: "#000000", light: "#FFFFFF" },
      });
      doc.addImage(dataUrl, "PNG", qrX, qrY, QR_SIZE, QR_SIZE, undefined, "FAST");

      // text
      doc.setTextColor("#111"); doc.setFont("helvetica", "bold"); doc.setFontSize(11);
      centerText(doc, state.rows[i].number, cardCx, qrY + QR_SIZE + 8);
      if (state.rows[i].name) { doc.setFont("helvetica", "normal"); doc.setFontSize(9);
        centerText(doc, state.rows[i].name, cardCx, qrY + QR_SIZE + 14); }
    }

    // Robust download (works even when save() is blocked)
    const dateStr = dayjs().format("YYYY-MM-DD");
    const blob = doc.output("blob");
    const url = URL.createObjectURL(blob);

    // Prefer opening in a new tab (reliable on iOS/Safari)
    const win = window.open(url, "_blank");
    if (!win) {
      // Fallback: force a download
      const a = document.createElement("a");
      a.href = url;
      a.download = `GKR-QR-Cards-${dateStr}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Cleanup the blob URL
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }
</script>
</body>
</html>
